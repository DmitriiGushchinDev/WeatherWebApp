{% extends "base.html" %}

{% block title %}Local Weather{% endblock %}

{% block content %}
<style>
/* ---- layout tweaks just for this page ---- */
.wx-grid {
  display: grid;
  grid-template-columns: 2fr 1.2fr;
  gap: 16px;
  margin-top: 16px;
}
.wx-daily { min-height: 360px; }
.wx-side { display: grid; gap: 16px; grid-auto-rows: minmax(0, auto); }
.days .day-row { padding: 10px 0; }
.hours-scroll .h-pill { min-width: 72px; padding: 10px 8px; }
/* responsive */
@media (max-width: 900px) {
  .wx-grid { grid-template-columns: 1fr; }
  .wx-daily, .wx-side { min-height: initial; }
}
</style>

{% if request.user.is_authenticated and not data.name in cities_list%}
  <a href="#" class="pill" style="position: absolute; right: 10px; top: 120px;" onclick="add_city_to_list()"> + </a>
  <span class='hovered-pill' style="display: inline-block; position: absolute; right: 10px; top: 80px;"> add the city to your list </span>
{% else %}
  <a href="{% url 'auth:login' %}" class="pill" style="position: absolute; right: 10px; top: 120px;"> + </a>
  <span class='hovered-pill' style="display: inline-block; position: absolute; right: 10px; top: 80px;"> login to add the city to your list </span>
{% endif %}

<section class="hero">
  <div class="place" id="place">—</div>
  <div class="big-temp" id="curTemp">—</div>
  <div class="cond-line" id="curCond">—</div>
  <div class="hilow" id="hiLo">—</div>
  <small id="localClock" class="hint"></small>
</section>

<section class="module glass">
  <div class="module-title">Next 24 hours</div>
  <div class="hours-scroll" id="hourlyStrip"></div>
</section>

<section class="wx-grid">
  <div class="wx-daily module glass">
    <div class="module-title">7-Day Forecast</div>
    <div id="dailyCompact" class="days-compact"></div>
  </div>

  <div class="wx-side">
    <div class="module glass">
      <div class="module-title">Location</div>
      <div class="kv"><span>City</span><b id="locCity">—</b></div>
      <div class="kv"><span>Region</span><b id="locRegion">—</b></div>
      <div class="kv"><span>Country</span><b><span id="locFlag">🏳️</span> <span id="locCountry">—</span></b></div>
      <div class="kv"><span>Coordinates</span><b id="coords">—</b></div>
      <div class="kv"><span>Timezone</span><b id="tzName">—</b></div>
    </div>

    <div class="module glass">
      <div class="module-title">Current Details</div>
      <div class="kv"><span>Humidity</span><b id="hum">—</b></div>
      <div class="kv"><span>UV Index</span><b id="uvi">—</b></div>
      <div class="kv"><span>Wind</span><b><span id="windSp">—</span>, <span id="windDir">—</span></b></div>
      <div class="kv"><span>Visibility</span><b id="vis">—</b></div>
      <div class="kv"><span>Sunrise</span><b id="sunrise">—</b></div>
      <div class="kv"><span>Sunset</span><b id="sunset">—</b></div>
    </div>
  </div>
</section>

<section class="module glass" style="margin-top:16px;">
  <div class="module-title">Network</div>
  <div class="kv"><span>IP</span><b id="ip">—</b></div>
  <div class="kv"><span>ISP / ASN</span><b id="isp">—</b></div>
  <div class="kv"><span>VPN?</span><b id="vpn">—</b></div>
</section>
{% endblock %}

{% block extra_js %}
{{ data|json_script:"wx-json" }}
{{ geo|json_script:"geo-json" }}

<script>
  function add_city_to_list() {
    console.log('add_city_to_list');
  }
</script>

<script>
(function () {
  const wx  = JSON.parse(document.getElementById('wx-json').textContent || '{}');   // OpenWeather One Call
  const geo = JSON.parse(document.getElementById('geo-json').textContent || '{}');  // IP geolocation

  /* ========== TIMEZONE: use the zone string; NO manual offset math ========== */
  const tzName = geo?.timezone?.name || wx?.timezone || 'UTC';

  /* ---------------- helpers ---------------- */
  const looksK = t => typeof t === 'number' && t > 200;
  const KtoC = k => k - 273.15;
  const tFmt = t => t == null ? '—' : `${Math.round(looksK(t) ? KtoC(t) : t)}°`;
  const visFmt = m => typeof m === 'number' ? (m>=1000 ? (m/1000).toFixed(1)+' km' : m+' m') : '—';
  const degToCompass = deg => ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round((deg||0)/22.5)%16];

  // time formatters that respect the target location's timezone
  const timeHM = (ts) => new Date(Number(ts) * 1000)
    .toLocaleTimeString([], { hour:'numeric', minute:'2-digit', timeZone: tzName });

  const dayShort = (ts) => new Date(Number(ts) * 1000)
    .toLocaleDateString([], { weekday:'short', timeZone: tzName });

  /* --------------- header/place --------------- */
  const place = `${geo.city || 'Your location'}, ${geo.region || ''}${geo.country ? ', '+geo.country : ''}`
    .replace(/, ,/g, ',').replace(/, $/,'');
  document.getElementById('place').textContent = place || (wx.timezone || 'Your location');

  /* --------------- hero --------------- */
  const cur = wx.current || {};
  document.getElementById('curTemp').textContent = tFmt(cur.temp);
  document.getElementById('curCond').textContent = (cur.weather?.[0]?.description || '—')
    .replace(/\b\w/g, m => m.toUpperCase());
  if (wx.daily && wx.daily.length) {
    const d0 = wx.daily[0];
    document.getElementById('hiLo').textContent = `H ${tFmt(d0.temp?.max)} · L ${tFmt(d0.temp?.min)}`;
  }

  /* --------------- local clock & tz --------------- */
  document.getElementById('tzName').textContent = tzName;
  function tick(){
    const now = new Date();
    document.getElementById('localClock').textContent =
      now.toLocaleString([], { timeZone: tzName, hour:'numeric', minute:'2-digit', second:'2-digit' });
  }
  tick(); setInterval(tick, 1000);

  /* --------------- location card --------------- */
  document.getElementById('locCity').textContent   = geo.city || '—';
  document.getElementById('locRegion').textContent = geo.region || '—';
  document.getElementById('locCountry').textContent= geo.country || '—';
  document.getElementById('locFlag').textContent   = geo.flag?.emoji || '';
  document.getElementById('coords').textContent    = `${wx.lat ?? '—'}, ${wx.lon ?? '—'}`;

  /* --------------- current details --------------- */
  document.getElementById('hum').textContent    = cur.humidity != null ? cur.humidity + '%' : '—';
  document.getElementById('uvi').textContent    = cur.uvi ?? '—';
  document.getElementById('windSp').textContent = (cur.wind_speed ?? '—') + (looksK(cur.temp) ? ' m/s' : '');
  document.getElementById('windDir').textContent= (cur.wind_deg != null ? `${cur.wind_deg}° ${degToCompass(cur.wind_deg)}` : '—');
  document.getElementById('vis').textContent    = visFmt(cur.visibility);
  if (cur.sunrise) document.getElementById('sunrise').textContent = timeHM(cur.sunrise);
  if (cur.sunset)  document.getElementById('sunset').textContent  = timeHM(cur.sunset);

  /* --------------- network card --------------- */
  document.getElementById('ip').textContent  = geo.ip_address || '—';
  const asn = geo?.connection?.autonomous_system_number;
  const org = geo?.connection?.autonomous_system_organization;
  document.getElementById('isp').textContent = [org, asn ? `AS${asn}` : null].filter(Boolean).join(' · ') || '—';
  document.getElementById('vpn').textContent = (geo?.security?.is_vpn === true) ? 'Yes' : 'No';

  /* --------------- hourly 24h (FIXED TIME) --------------- */
  const hourly = (wx.hourly || []).slice(0, 24);
  const hourlyHTML = hourly.map(h => {
    const popPct  = Math.round((h.pop || 0) * 100);
    const topIcon = popPct === 0 ? '☀️' : (popPct < 70 ? '💧' : '💦');

    const rain1h = (h.rain && (h.rain['1h'] ?? h.rain['1H'])) || 0;
    const snow1h = (h.snow && (h.snow['1h'] ?? h.snow['1H'])) || 0;
    const hasSnow = snow1h > rain1h;
    const amt = (rain1h || snow1h) ? (rain1h || snow1h).toFixed(1) : '—';
    const amtLabel = hasSnow ? 'Snow' : 'Rain';
    const amtIcon  = hasSnow ? '❄️' : '💧';

    const fromDeg   = h.wind_deg ?? 0;
    const towardDeg = (fromDeg + 180) % 360;
    const towardTxt = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round((towardDeg||0)/22.5)%16];
    const sp        = h.wind_speed ?? '—';

    const popClass = popPct === 0 ? 'zero' : (popPct < 70 ? 'mid' : 'high');

    return `
      <div class="h-card" title="${(h.weather?.[0]?.description || '').replace(/"/g,'&quot;')}">
        <div class="t">${timeHM(h.dt)}</div>
        <div class="ico">${topIcon}</div>
        <div class="temp">${tFmt(h.temp)}</div>
        <div class="feels">feels ${tFmt(h.feels_like)}</div>

        <div class="windbox" aria-label="Wind blowing toward ${towardTxt}">
          <span class="windto">${sp} m/s → ${towardTxt}</span>
        </div>

        <div class="metrics">
          <div class="chip pop ${popClass}" title="Probability of precipitation">
            <span class="label">Chance</span><span class="val">${popPct}%</span>
          </div>
          <div class="chip" title="${amtLabel} amount (last/next 1h)">
            <span>${amtIcon}</span><span class="label">${amtLabel}</span><span class="val">${amt} ${amt === '—' ? '' : 'mm'}</span>
          </div>
          <div class="chip" title="Relative humidity">
            <span>💨</span><span class="label">RH</span><span class="val">${h.humidity ?? '—'}%</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
  document.getElementById('hourlyStrip').innerHTML = hourlyHTML;

  /* --------------- daily 7d (also use tz for names) --------------- */
  const daily = (wx.daily || []).slice(0, 7);
  const allTemps = daily.flatMap(d => [d?.temp?.min, d?.temp?.max]).filter(v => typeof v === 'number');
  const toC = v => looksK(v) ? (v - 273.15) : v;
  const loAll = allTemps.length ? Math.min(...allTemps.map(toC)) : 0;
  const hiAll = allTemps.length ? Math.max(...allTemps.map(toC)) : 1;
  const rng = Math.max(4, hiAll - loAll);
  const normPct = vC => Math.min(100, Math.max(0, ((vC - loAll) / rng) * 100));
  const tTxt = v => v == null ? '—' : Math.round(toC(v)) + '°';
  const iconFrom = d => { const p = Math.round((d.pop || 0) * 100); return p===0?'☀️':(p<70?'💧':'💦'); };

  document.getElementById('dailyCompact').innerHTML = daily.map(d => {
    const dayName = dayShort(d.dt);
    const minC = toC(d?.temp?.min), maxC = toC(d?.temp?.max);
    const loPct = normPct(minC ?? loAll);
    const hiPct = normPct(maxC ?? hiAll);
    const popPct = Math.round((d.pop || 0) * 100);
    const badgeCls = popPct === 0 ? 'zero' : (popPct >= 70 ? 'high' : '');

    return `
      <div class="day-mini" title="${(d.summary || d.weather?.[0]?.description || '').replace(/"/g,'&quot;')}">
        <div class="w">${dayName}</div>
        <div class="ico">${iconFrom(d)}</div>
        <div class="bar" style="--lo:${loPct}; --hi:${hiPct};"></div>
        <div class="temps"><span>${tTxt(d.temp?.min)}</span><span>${tTxt(d.temp?.max)}</span></div>
        <div class="badge ${badgeCls}">${popPct}%</div>
      </div>
    `;
  }).join('');
})();
</script>
{% endblock %}