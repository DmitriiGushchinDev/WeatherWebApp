{% extends "base.html" %}
{% load static %}


{% block title %}Weather{% endblock %}

{% block extra_head %}
<style>
  .wrap{max-width:960px;margin:2rem auto;padding:0 1rem}
  .stack{display:grid;gap:1rem}
  .card{background:var(--surface,rgba(255,255,255,.06));border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:1rem}
  .row{display:flex;align-items:center;gap:.75rem}
  .space{display:flex;justify-content:space-between;gap:1rem;align-items:center}
  .muted{color:#6b7280}
  .h1{font-size:1.25rem;font-weight:600}
  .big{font-size:3rem;line-height:1}
  .chips{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem}
  .chip{border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:.35rem .6rem;text-align:center;white-space:nowrap}
  .scroller{display:grid;grid-auto-flow:column;gap:.75rem;overflow-x:auto;padding-bottom:.25rem}
  .cell{min-width:96px;text-align:center}
  .icon{width:48px;height:48px}
  .small{font-size:.92rem}
</style>
{% endblock %}

{% block content %}
<div class="wrap stack">

  <!-- Location -->
  <div class="card">
    {% with a=geo.addresses.0.address %}
      <div class="h1">
        {{ a.municipality|default:a.localName }},
        {{ a.countrySubdivisionName|default:a.countrySubdivision }},
        {{ a.country|default:a.countryCode }}
      </div>
      <div class="muted small">{{ a.freeformAddress }}</div>
    {% endwith %}
    <a class="pill" style="position: absolute; right: 10px; top: 120px;"  onclick="toggle_direction()">+</a>
  </div>


  <!-- Current -->
  <div class="card">
    <div class="space">
      <div class="stack">
        <div class="muted small" id="nowTime"
             data-dt="{{ data.current.dt }}" data-offset="{{ data.timezone_offset }}">—</div>
        <div class="row" style="align-items:flex-end">
          <div class="big">{{ data.current.temp|floatformat:0|add:"-273"|floatformat:0 }}°C</div>
          <div class="muted small">{{ data.current.weather.0.description|capfirst }}</div>
        </div>
      </div>
      <img class="icon"
           src="https://openweathermap.org/img/wn/{{ data.current.weather.0.icon }}@2x.png"
           alt="{{ data.current.weather.0.main }}">
    </div>

    <div class="chips small" style="margin-top:.75rem">
      <div class="chip">Feels {{ data.current.feels_like|floatformat:0 }}°C</div>
      <div class="chip">Humidity {{ data.current.humidity }}%</div>
      <div class="chip">Pressure {{ data.current.pressure }} hPa</div>
      <div class="chip">Wind {{ data.current.wind_speed }} m/s @ {{ data.current.wind_deg }}°</div>
      <div class="chip">UV {{ data.current.uvi }}</div>
      <div class="chip">Clouds {{ data.current.clouds }}%</div>
      <div class="chip">Visibility {{ data.current.visibility|divisibleby:1000|floatformat:0 }} km</div>
    </div>
  </div>

  <!-- Next hours -->
  <div class="card">
    <div class="h1">Next hours</div>
    <div class="scroller small" id="hourly" data-offset="{{ data.timezone_offset }}">
      {% for h in data.hourly|slice:":8" %}
      <div class="cell stack">
        <div class="muted hour" data-dt="{{ h.dt }}">—:—</div>
        <img class="icon" src="https://openweathermap.org/img/wn/{{ h.weather.0.icon }}.png"
             alt="{{ h.weather.0.main }}">
        <div><strong>{{ h.temp|add:"-273"|floatformat:0 }}°C</strong></div>
        <div class="muted">{{ h.weather.0.main }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Next days -->
  <div class="card">
    <div class="h1">Next days</div>
    <div class="stack small">
      {% for d in data.daily|slice:":6" %}
      <div class="space">
        <div class="row">
          <div class="muted day" data-dt="{{ d.dt }}" data-offset="{{ data.timezone_offset }}">—</div>
          <img class="icon" src="https://openweathermap.org/img/wn/{{ d.weather.0.icon }}.png"
               alt="{{ d.weather.0.main }}">
          <div class="muted">{{ d.summary|default:d.weather.0.description|capfirst }}</div>
        </div>
        <div>
          <strong>{{ d.temp.max|floatformat:0|add:"-273"|floatformat:0 }}°</strong>
          <span class="muted">/ {{ d.temp.min|floatformat:0|add:"-273"|floatformat:0 }}°C</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
  function fmtLocal(unix, offset, opts){
    const d = new Date((Number(unix) + Number(offset)) * 1000);
    return d.toLocaleString(undefined, opts || {hour:'2-digit', minute:'2-digit'});
  }
  function fmtDay(unix, offset){
    const d = new Date((Number(unix) + Number(offset)) * 1000);
    return d.toLocaleDateString(undefined, {weekday:'short'});
  }
  // header time
  (function(){
    const el = document.getElementById('nowTime');
    if(!el) return;
    const dt = el.dataset.dt, off = el.dataset.offset;
    function tick(){ el.textContent = fmtLocal(dt, off, {weekday:'short', hour:'2-digit', minute:'2-digit'}); }
    tick(); setInterval(tick, 60000);
  })();
  // hourly labels
  (function(){
    const box = document.getElementById('hourly');
    if(!box) return;
    const off = box.dataset.offset;
    box.querySelectorAll('.hour').forEach(h => {
      h.textContent = fmtLocal(h.dataset.dt, off, {hour:'2-digit', minute:'2-digit'});
    });
  })();
  // day names
  document.querySelectorAll('.day').forEach(d=>{
    d.textContent = fmtDay(d.dataset.dt, d.dataset.offset);
  });
</script>
{% endblock %}