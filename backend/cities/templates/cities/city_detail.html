{% extends "base.html" %}
{% load static %}


{% block title %}Weather{% endblock %}

{% block content %}
<style>
  /* ---- layout tweaks just for this page ---- */
  .wx-grid {
    display: grid;
    grid-template-columns: 2fr 1.2fr;
    gap: 16px;
    margin-top: 16px;
  }
  .wx-daily { min-height: 360px; }
  .wx-side { display: grid; gap: 16px; grid-auto-rows: minmax(0, auto); }
  .days .day-row { padding: 10px 0; }
  .hours-scroll .h-pill { min-width: 72px; padding: 10px 8px; }
  /* responsive */
  @media (max-width: 900px) {
    .wx-grid { grid-template-columns: 1fr; }
    .wx-daily, .wx-side { min-height: initial; }
  }
  </style>

  {% if request.user.is_authenticated and not geo.addresses.0.address.localName in cities_list %}
  <a class="pill" style="position: absolute; right: 10px; top: 120px;"  onclick="addCityToProfile(event)" 
  data-city-name="{{ geo.addresses.0.address.localName }}"
  data-country="{{ geo.addresses.0.address.country }}"
  data-latitude="{{ data.lat }}"
  data-longitude="{{ data.lon }}">+</a>
{% endif %}

<section class="hero">
  <div class="place" id="place">-</div>
  <div class="big-temp" id="curTemp">‚Äî</div>
  <div class="cond-line" id="curCond">‚Äî</div>
  <div class="hilow" id="hiLo">‚Äî</div>
  <small id="localClock" class="hint"></small>
</section>

<section class="module glass">
  <div class="module-title">Next 24 hours</div>
  <div class="hours-scroll" id="hourlyStrip"></div>
</section>

<div class="module glass">
  <div class="module-title">Weather Description</div>
  <div class="kv"><span></span><b id="weatherDescription">‚Äî</b></div>
</div>

<div class="module glass">
  <div class="module-title">What to Wear</div>
  <div class="kv"><span></span><b id="whatToWear">‚Äî</b></div>
</div>


<div class="wx-daily module glass" style="min-height: 200px;">
  <div class="module-title" >7-Day Forecast</div>
  <div id="dailyCompact" class="days-compact"></div>
</div>


<div class="wx-side">
<div class="module glass">
<div class="module-title">Location</div>
<div class="kv"><span>City</span><b id="locCity">‚Äî</b></div>
<div class="kv"><span>Region</span><b id="locRegion">‚Äî</b></div>
<div class="kv"><span>Country</span><b><span id="locFlag">üè≥Ô∏è</span> <span id="locCountry">‚Äî</span></b></div>
<div class="kv"><span>Coordinates</span><b id="coords">‚Äî</b></div>
<div class="kv"><span>Timezone</span><b id="tzName">‚Äî</b></div>
</div>

<div class="module glass">
<div class="module-title">Current Details</div>
<div class="kv"><span>Humidity</span><b id="hum">‚Äî</b></div>
<div class="kv"><span>UV Index</span><b id="uvi">‚Äî</b></div>
<div class="kv"><span>Wind</span><b><span id="windSp">‚Äî</span>, <span id="windDir">‚Äî</span></b></div>
<div class="kv"><span>Visibility</span><b id="vis">‚Äî</b></div>
<div class="kv"><span>Sunrise</span><b id="sunrise">‚Äî</b></div>
<div class="kv"><span>Sunset</span><b id="sunset">‚Äî</b></div>
</div>
</div>
</section>

<section class="module glass" style="margin-top:16px;">
<div class="module-title">Network</div>
<div class="kv"><span>IP</span><b id="ip">‚Äî</b></div>
<div class="kv"><span>ISP / ASN</span><b id="isp">‚Äî</b></div>
<div class="kv"><span>VPN?</span><b id="vpn">‚Äî</b></div>
</section>

{% endblock %}

{% block extra_js %}

<script>
  function addCityToProfile(event){
    event.preventDefault(); // <-- important for <a> clicks

    const btn = event.currentTarget;
    const city = btn.dataset.cityName;
    const country = btn.dataset.country;
    const lat = parseFloat(btn.dataset.latitude);
    const lon = parseFloat(btn.dataset.longitude);
    btn.style.pointerEvents = 'none';
    btn.textContent = 'Added';

    fetch('{% url "cities:add_city_to_profile" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        name: city,
        country: country,
        lat: lat,
        lon: lon,
      })
    })  
    .then(response => response.json())  
    .then(data => {
      btn.style.display = 'none';
    })
    .catch(error => {
      console.error('Error:', error);
      btn.style.pointerEvents = 'auto';
      btn.textContent = '+';
    });
  }
</script>



{{ data|json_script:"wx-json" }}
{{ geo|json_script:"geo-json" }}
<script>
(function () {
const wx  = JSON.parse(document.getElementById('wx-json').textContent || '{}');   // OpenWeather One Call
const geo = JSON.parse(document.getElementById('geo-json').textContent || '{}');  // IP geolocation

// helpers
const tzOffset = Number(wx.timezone_offset || 0);
const toLocal = ts => new Date((ts + tzOffset) * 1000);
const timeHM = d => d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
const dayShort = d => d.toLocaleDateString([], {weekday:'short'});
const looksK = t => typeof t === 'number' && t > 200;
const KtoC = k => k - 273.15;
const tFmt = t => t == null ? '‚Äî' : `${Math.round(looksK(t) ? KtoC(t) : t)}¬∞`;
const visFmt = m => typeof m === 'number' ? (m>=1000 ? (m/1000).toFixed(1)+' km' : m+' m') : '‚Äî';
const degToCompass = deg => ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round((deg||0)/22.5)%16];

document.getElementById('weatherDescription').innerHTML = '{{ description_data.description }}';
document.getElementById('whatToWear').innerHTML = '{{ description_data.what_to_wear }}';
// header/place
const addr = geo.addresses?.[0]?.address || {};
const place = `${addr.localName || ''}, , ${addr.country || ''}`
    .replace(/, ,/g, ',')
    .replace(/, $/, '');
document.getElementById('place').textContent = place || 'Your location';
// hero
const cur = wx.current || {};
document.getElementById('curTemp').textContent = tFmt(cur.temp);
document.getElementById('curCond').textContent = (cur.weather?.[0]?.description || '‚Äî')
.replace(/\b\w/g, m => m.toUpperCase());
if (wx.daily && wx.daily.length) {
const d0 = wx.daily[0];
document.getElementById('hiLo').textContent = `H ${tFmt(d0.temp?.max)} ¬∑ L ${tFmt(d0.temp?.min)}`;
}

// local clock & tz
const tzName = geo.timezone?.name || wx.timezone || '‚Äî';
document.getElementById('tzName').textContent = tzName;
function tick(){
const base = new Date();
try {
document.getElementById('localClock').textContent =
  base.toLocaleString([], { timeZone: tzName, hour:'numeric', minute:'2-digit', second:'2-digit' });
} catch {
const d = new Date(base.getTime() + tzOffset*1000);
document.getElementById('localClock').textContent = d.toLocaleTimeString();
}
}
tick(); setInterval(tick, 1000);

// location card
const address = geo.addresses?.[0]?.address || {};
document.getElementById('locCity').textContent   = address.localName || '‚Äî';
document.getElementById('locRegion').textContent = address.countrySubdivisionName || '‚Äî';
document.getElementById('locCountry').textContent= address.country || '‚Äî';
document.getElementById('locFlag').textContent   = geo.flag?.emoji || '';
document.getElementById('coords').textContent    = geo.addresses?.[0]?.position || '‚Äî';
// current details
document.getElementById('hum').textContent = cur.humidity != null ? cur.humidity + '%' : '‚Äî';
document.getElementById('uvi').textContent = cur.uvi ?? '‚Äî';
document.getElementById('windSp').textContent = (cur.wind_speed ?? '‚Äî') + (looksK(cur.temp) ? ' m/s' : '');
document.getElementById('windDir').textContent = (cur.wind_deg != null ? `${cur.wind_deg}¬∞ ${degToCompass(cur.wind_deg)}` : '‚Äî');
document.getElementById('vis').textContent = visFmt(cur.visibility);
if (cur.sunrise) document.getElementById('sunrise').textContent = timeHM(toLocal(cur.sunrise));
if (cur.sunset)  document.getElementById('sunset').textContent  = timeHM(toLocal(cur.sunset));

// network card
document.getElementById('ip').textContent  = geo.ip_address || '‚Äî';
const asn = geo.connection?.autonomous_system_number;
const org = geo.connection?.autonomous_system_organization;
document.getElementById('isp').textContent = [org, asn ? `AS${asn}` : null].filter(Boolean).join(' ¬∑ ') || '‚Äî';
document.getElementById('vpn').textContent = (geo.security?.is_vpn === true) ? 'Yes' : 'No';

// hourly 24h
// ------- Hourly 24h (clear, labeled tiles) -------
const hourly = (wx.hourly || []).slice(0, 24);
const hourlyHTML = hourly.map(h => {
// precip chance + icon logic (for the big top icon)
const popPct = Math.round((h.pop || 0) * 100);
const topIcon = popPct === 0 ? '‚òÄÔ∏è' : (popPct < 70 ? 'üíß' : 'üí¶');

// precip amount (prefer rain then snow)
const rain1h = (h.rain && (h.rain['1h'] ?? h.rain['1H'])) || 0;
const snow1h = (h.snow && (h.snow['1h'] ?? h.snow['1H'])) || 0;
const hasSnow = snow1h > rain1h;
const amt = (rain1h || snow1h) ? (rain1h || snow1h).toFixed(1) : '‚Äî';
const amtLabel = hasSnow ? 'Snow' : 'Rain';
const amtIcon  = hasSnow ? '‚ùÑÔ∏è' : 'üíß';

// wind: OpenWeather gives FROM; show TO for clarity on arrow + label
const fromDeg   = h.wind_deg ?? 0;
const towardDeg = (fromDeg + 180) % 360;
const towardTxt = degToCompass(towardDeg);
const sp        = h.wind_speed ?? '‚Äî';
const needleRot = `rotate(${towardDeg}deg)`;

// chance chip color
const popClass = popPct === 0 ? 'zero' : (popPct < 70 ? 'mid' : 'high');

return `
<div class="h-card" title="${(h.weather?.[0]?.description || '').replace(/"/g,'&quot;')}">
<div class="t">${timeHM(toLocal(h.dt))}</div>
<div class="ico">${topIcon}</div>
<div class="temp">${tFmt(h.temp)}</div>
<div class="feels">feels ${tFmt(h.feels_like)}</div>

<div class="windbox" aria-label="Wind blowing toward ${towardTxt}">
  <span class="windcomp">
    <span class="ring"></span>
    <span class="needle" style="transform:${needleRot}"></span>
    <span class="head"   style="transform: translate(-50%, -100%) ${needleRot}"></span>
    <span class="hub"></span>
  </span>
  <span class="windto">${sp} m/s ‚Üí ${towardTxt}</span>
</div>

<div class="metrics">
  <div class="chip pop ${popClass}" title="Probability of precipitation">
    <span class="label">Chance</span><span class="val">${popPct}%</span>
  </div>
  <div class="chip" title="${amtLabel} amount (last/next 1h)">
    <span>${amtIcon}</span><span class="label">${amtLabel}</span><span class="val">${amt} ${amt === '‚Äî' ? '' : 'mm'}</span>
  </div>
  <div class="chip" title="Relative humidity">
    <span>üí®</span><span class="label">RH</span><span class="val">${h.humidity ?? '‚Äî'}%</span>
  </div>
</div>
</div>
`;
}).join('');

document.getElementById('hourlyStrip').innerHTML = hourlyHTML;
// daily 7d
const daily = (wx.daily || []).slice(0, 7);

// compute a scale so the min/max temps map to 0‚Äì100 for nice bars
const allTemps = daily.flatMap(d => [d?.temp?.min, d?.temp?.max]).filter(v => typeof v === 'number');
const kToC = k => k - 273.15;
const toC = v => looksK(v) ? kToC(v) : v;

const loAll = Math.min(...allTemps.map(toC));
const hiAll = Math.max(...allTemps.map(toC));
const rng = Math.max(4, hiAll - loAll); // avoid zero-width bars

function normPct(vC) {
return Math.min(100, Math.max(0, ((vC - loAll) / rng) * 100));
}
function tTxt(v) { return v == null ? '‚Äî' : Math.round(toC(v)) + '¬∞'; }

function iconFrom(d) {
const popPct = Math.round((d.pop || 0) * 100);
if (popPct === 0) return '‚òÄÔ∏è';
if (popPct < 70)  return 'üíß';
return 'üí¶';
}

document.getElementById('dailyCompact').innerHTML = daily.map(d => {
const dayName = new Date((d.dt + (wx.timezone_offset||0)) * 1000)
              .toLocaleDateString([], { weekday:'short' });
const minC = toC(d?.temp?.min), maxC = toC(d?.temp?.max);
const loPct = normPct(minC ?? loAll);
const hiPct = normPct(maxC ?? hiAll);
const popPct = Math.round((d.pop || 0) * 100);
const badgeCls = popPct === 0 ? 'zero' : (popPct >= 70 ? 'high' : '');

return `
<div class="day-mini" title="${d.summary || d.weather?.[0]?.description || ''}">
<div class="w">${dayName}</div>
<div class="ico">${iconFrom(d)}</div>
<div class="bar" style="--lo:${loPct}; --hi:${hiPct};"></div>
<div class="temps"><span>${tTxt(d.temp?.min)}</span><span>${tTxt(d.temp?.max)}</span></div>
<div class="badge ${badgeCls}">${popPct}%</div>
</div>
`;
}).join('');
})();
</script>
{% endblock %}

















{% comment %} 


<style>
  .wrap{max-width:960px;margin:2rem auto;padding:0 1rem}
  .stack{display:grid;gap:1rem}
  .card{background:var(--surface,rgba(255,255,255,.06));border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:1rem}
  .row{display:flex;align-items:center;gap:.75rem}
  .space{display:flex;justify-content:space-between;gap:1rem;align-items:center}
  .muted{color:#6b7280}
  .h1{font-size:1.25rem;font-weight:600}
  .big{font-size:3rem;line-height:1}
  .chips{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem}
  .chip{border:1px solid rgba(0,0,0,.12);border-radius:999px;padding:.35rem .6rem;text-align:center;white-space:nowrap}
  .scroller{display:grid;grid-auto-flow:column;gap:.75rem;overflow-x:auto;padding-bottom:.25rem}
  .cell{min-width:96px;text-align:center}
  .icon{width:48px;height:48px}
  .small{font-size:.92rem}
</style>


{% block content %}
<div class="wrap stack">

  <!-- Location -->
  <div class="card">
    {% with a=geo.addresses.0.address %}
      <div class="h1">
        {{ a.municipality|default:a.localName }},
        {{ a.countrySubdivisionName|default:a.countrySubdivision }},
        {{ a.country|default:a.countryCode }}
      </div>
      <div class="muted small">{{ a.freeformAddress }}</div>
    {% endwith %}
    {% if request.user.is_authenticated and not geo.addresses.0.address.localName in cities_list %}
      <a class="pill" style="position: absolute; right: 10px; top: 120px;"  onclick="addCityToProfile(event)" 
      data-city-name="{{ geo.addresses.0.address.localName }}"
      data-country="{{ geo.addresses.0.address.country }}"
      data-latitude="{{ data.lat }}"
      data-longitude="{{ data.lon }}">+</a>
    {% endif %}
  </div>


  <!-- Current -->
  <div class="card">
    <div class="space">
      <div class="stack">
        <div class="muted small" id="nowTime"
             data-dt="{{ data.current.dt }}" data-offset="{{ data.timezone_offset }}">‚Äî</div>
        <div class="row" style="align-items:flex-end">
          <div class="big">{{ data.current.temp|floatformat:0|add:"-273"|floatformat:0 }}¬∞C</div>
          <div class="muted small">{{ data.current.weather.0.description|capfirst }}</div>
        </div>
      </div>
      <img class="icon"
           src="https://openweathermap.org/img/wn/{{ data.current.weather.0.icon }}@2x.png"
           alt="{{ data.current.weather.0.main }}">
    </div>

    <div class="chips small" style="margin-top:.75rem">
      <div class="chip">Feels {{ data.current.feels_like|floatformat:0 }}¬∞C</div>
      <div class="chip">Humidity {{ data.current.humidity }}%</div>
      <div class="chip">Pressure {{ data.current.pressure }} hPa</div>
      <div class="chip">Wind {{ data.current.wind_speed }} m/s @ {{ data.current.wind_deg }}¬∞</div>
      <div class="chip">UV {{ data.current.uvi }}</div>
      <div class="chip">Clouds {{ data.current.clouds }}%</div>
      <div class="chip">Visibility {{ data.current.visibility|divisibleby:1000|floatformat:0 }} km</div>
    </div>
  </div>

  <!-- Next hours -->
  <div class="card">
    <div class="h1">Next hours</div>
    <div class="scroller small" id="hourly" data-offset="{{ data.timezone_offset }}">
      {% for h in data.hourly|slice:":8" %}
      <div class="cell stack">
        <div class="muted hour" data-dt="{{ h.dt }}">‚Äî:‚Äî</div>
        <img class="icon" src="https://openweathermap.org/img/wn/{{ h.weather.0.icon }}.png"
             alt="{{ h.weather.0.main }}">
        <div><strong>{{ h.temp|add:"-273"|floatformat:0 }}¬∞C</strong></div>
        <div class="muted">{{ h.weather.0.main }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Next days -->
  <div class="card">
    <div class="h1">Next days</div>
    <div class="stack small">
      {% for d in data.daily|slice:":6" %}
      <div class="space">
        <div class="row">
          <div class="muted day" data-dt="{{ d.dt }}" data-offset="{{ data.timezone_offset }}">‚Äî</div>
          <img class="icon" src="https://openweathermap.org/img/wn/{{ d.weather.0.icon }}.png"
               alt="{{ d.weather.0.main }}">
          <div class="muted">{{ d.summary|default:d.weather.0.description|capfirst }}</div>
        </div>
        <div>
          <strong>{{ d.temp.max|floatformat:0|add:"-273"|floatformat:0 }}¬∞</strong>
          <span class="muted">/ {{ d.temp.min|floatformat:0|add:"-273"|floatformat:0 }}¬∞C</span>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

</div>
{% endblock %}

{% block extra_js %}

<script>
  function addCityToProfile(event){
    event.preventDefault(); // <-- important for <a> clicks

    const btn = event.currentTarget;
    const city = btn.dataset.cityName;
    const country = btn.dataset.country;
    const lat = parseFloat(btn.dataset.latitude);
    const lon = parseFloat(btn.dataset.longitude);
    btn.style.pointerEvents = 'none';
    btn.textContent = 'Added';

    fetch('{% url "cities:add_city_to_profile" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: JSON.stringify({
        name: city,
        country: country,
        lat: lat,
        lon: lon,
      })
    })  
    .then(response => response.json())  
    .then(data => {
      btn.style.display = 'none';
    })
    .catch(error => {
      console.error('Error:', error);
      btn.style.pointerEvents = 'auto';
      btn.textContent = '+';
    });
  }
</script>

<script>
  function fmtLocal(unix, offset, opts){
    const d = new Date((Number(unix) + Number(offset)) * 1000);
    return d.toLocaleString(undefined, opts || {hour:'2-digit', minute:'2-digit'});
  }
  function fmtDay(unix, offset){
    const d = new Date((Number(unix) + Number(offset)) * 1000);
    return d.toLocaleDateString(undefined, {weekday:'short'});
  }
  // header time
  (function(){
    const el = document.getElementById('nowTime');
    if(!el) return;
    const dt = el.dataset.dt, off = el.dataset.offset;
    function tick(){ el.textContent = fmtLocal(dt, off, {weekday:'short', hour:'2-digit', minute:'2-digit'}); }
    tick(); setInterval(tick, 60000);
  })();
  // hourly labels
  (function(){
    const box = document.getElementById('hourly');
    if(!box) return;
    const off = box.dataset.offset;
    box.querySelectorAll('.hour').forEach(h => {
      h.textContent = fmtLocal(h.dataset.dt, off, {hour:'2-digit', minute:'2-digit'});
    });
  })();
  // day names
  document.querySelectorAll('.day').forEach(d=>{
    d.textContent = fmtDay(d.dataset.dt, d.dataset.offset);
  });
</script>
{% endblock %} {% endcomment %}
