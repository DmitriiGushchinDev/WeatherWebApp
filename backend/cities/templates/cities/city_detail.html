{% extends "base.html" %}
{% load static %}

{% block title %}Weather{% endblock %}

{% block content %}
<style>
  /* ---- layout tweaks just for this page ---- */
  .wx-grid {
    display: grid;
    grid-template-columns: 2fr 1.2fr;
    gap: 16px;
    margin-top: 16px;
  }
  .wx-daily { min-height: 360px; }
  .wx-side { display: grid; gap: 16px; grid-auto-rows: minmax(0, auto); }
  .days .day-row { padding: 10px 0; }
  .hours-scroll .h-pill { min-width: 72px; padding: 10px 8px; }
  /* responsive */
  @media (max-width: 900px) {
    .wx-grid { grid-template-columns: 1fr; }
    .wx-daily, .wx-side { min-height: initial; }
  }
  </style>

{% if request.user.is_authenticated and not geo.addresses.0.address.localName in cities_list %}
  <a class="pill" style="position: absolute; right: 10px; top: 120px;"  onclick="addCityToProfile(event)" 
     data-city-name="{{ geo.addresses.0.address.localName }}"
     data-country="{{ geo.addresses.0.address.country }}"
     data-latitude="{{ data.lat }}"
     data-longitude="{{ data.lon }}">+</a>
{% endif %}

<section class="hero">
  <div class="place" id="place">-</div>
  <div class="big-temp" id="curTemp">â€”</div>
  <div class="cond-line" id="curCond">â€”</div>
  <div class="hilow" id="hiLo">â€”</div>
  <small id="localClock" class="hint"></small>
</section>

<section class="module glass">
  <div class="module-title">Next 24 hours</div>
  <div class="hours-scroll" id="hourlyStrip"></div>
</section>

<div class="module glass">
  <div class="module-title">Weather Description</div>
  <div class="kv"><span></span><b id="weatherDescription">â€”</b></div>
</div>

<div class="module glass">
  <div class="module-title">What to Wear</div>
  <div class="kv"><span></span><b id="whatToWear">â€”</b></div>
</div>

<div class="wx-daily module glass" style="min-height: 200px;">
  <div class="module-title">7-Day Forecast</div>
  <div id="dailyCompact" class="days-compact"></div>
</div>

<div class="wx-side">
  <div class="module glass">
    <div class="module-title">Location</div>
    <div class="kv"><span>City</span><b id="locCity">â€”</b></div>
    <div class="kv"><span>Region</span><b id="locRegion">â€”</b></div>
    <div class="kv"><span>Country</span><b><span id="locFlag">ğŸ³ï¸</span> <span id="locCountry">â€”</span></b></div>
    <div class="kv"><span>Coordinates</span><b id="coords">â€”</b></div>
    <div class="kv"><span>Timezone</span><b id="tzName">â€”</b></div>
  </div>

  <div class="module glass">
    <div class="module-title">Current Details</div>
    <div class="kv"><span>Humidity</span><b id="hum">â€”</b></div>
    <div class="kv"><span>UV Index</span><b id="uvi">â€”</b></div>
    <div class="kv"><span>Wind</span><b><span id="windSp">â€”</span>, <span id="windDir">â€”</span></b></div>
    <div class="kv"><span>Visibility</span><b id="vis">â€”</b></div>
    <div class="kv"><span>Sunrise</span><b id="sunrise">â€”</b></div>
    <div class="kv"><span>Sunset</span><b id="sunset">â€”</b></div>
  </div>
</div>

<section class="module glass" style="margin-top:16px;">
  <div class="module-title">Network</div>
  <div class="kv"><span>IP</span><b id="ip">â€”</b></div>
  <div class="kv"><span>ISP / ASN</span><b id="isp">â€”</b></div>
  <div class="kv"><span>VPN?</span><b id="vpn">â€”</b></div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  function addCityToProfile(event){
    event.preventDefault();
    const btn = event.currentTarget;
    const city = btn.dataset.cityName;
    const country = btn.dataset.country;
    const lat = parseFloat(btn.dataset.latitude);
    const lon = parseFloat(btn.dataset.longitude);
    btn.style.pointerEvents = 'none';
    btn.textContent = 'Added';

    fetch('{% url "cities:add_city_to_profile" %}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
      body: JSON.stringify({ name: city, country, lat, lon })
    })
    .then(r => r.json())
    .then(() => { btn.style.display = 'none'; })
    .catch(err => { console.error(err); btn.style.pointerEvents='auto'; btn.textContent='+'; });
  }
</script>

{{ data|json_script:"wx-json" }}
{{ geo|json_script:"geo-json" }}

<script>
(function () {
  const wx  = JSON.parse(document.getElementById('wx-json').textContent || '{}');   // OpenWeather One Call
  const geo = JSON.parse(document.getElementById('geo-json').textContent || '{}');  // IP geolocation

  /* ----------- TIMEZONE: use string, no manual offset math ----------- */
  const tzName = geo?.timezone?.name || wx?.timezone || 'UTC';

  /* ----------------------- helpers ----------------------- */
  const looksK = t => typeof t === 'number' && t > 200;
  const KtoC = k => k - 273.15;
  const tFmt = t => t == null ? 'â€”' : `${Math.round(looksK(t) ? KtoC(t) : t)}Â°`;
  const visFmt = m => typeof m === 'number' ? (m>=1000 ? (m/1000).toFixed(1)+' km' : m+' m') : 'â€”';
  const degToCompass = deg => ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'][Math.round((deg||0)/22.5)%16];

  // time formatters that use the target zone
  const timeHM = (ts) => new Date(Number(ts) * 1000)
    .toLocaleTimeString([], { hour:'numeric', minute:'2-digit', timeZone: tzName });

  const dayShort = (ts) => new Date(Number(ts) * 1000)
    .toLocaleDateString([], { weekday:'short', timeZone: tzName });

  // description / wear (server-provided strings)
  document.getElementById('weatherDescription').innerHTML = '{{ description_data.description|default_if_none:""|escapejs }}';
  document.getElementById('whatToWear').innerHTML         = '{{ description_data.what_to_wear|default_if_none:""|escapejs }}';

  /* ---------------------- header / place ---------------------- */
  const addr = geo?.addresses?.[0]?.address || {};
  const place = `${addr.localName || ''}${addr.country ? ', ' + addr.country : ''}`.trim() || 'Your location';
  document.getElementById('place').textContent = place;

  // current hero
  const cur = wx.current || {};
  document.getElementById('curTemp').textContent = tFmt(cur.temp);
  document.getElementById('curCond').textContent =
    (cur.weather?.[0]?.description || 'â€”').replace(/\b\w/g, m => m.toUpperCase());
  if (wx.daily && wx.daily.length) {
    const d0 = wx.daily[0];
    document.getElementById('hiLo').textContent = `H ${tFmt(d0.temp?.max)} Â· L ${tFmt(d0.temp?.min)}`;
  }

  // local clock + tz label
  document.getElementById('tzName').textContent = tzName || 'â€”';
  function tick(){
    const now = new Date();
    document.getElementById('localClock').textContent =
      now.toLocaleString([], { timeZone: tzName, hour:'numeric', minute:'2-digit', second:'2-digit' });
  }
  tick(); setInterval(tick, 1000);

  /* ---------------------- location card ---------------------- */
  document.getElementById('locCity').textContent   = addr.localName || 'â€”';
  document.getElementById('locRegion').textContent = addr.countrySubdivisionName || 'â€”';
  document.getElementById('locCountry').textContent= addr.country || 'â€”';
  document.getElementById('locFlag').textContent   = geo?.flag?.emoji || '';
  document.getElementById('coords').textContent    = geo?.addresses?.[0]?.position || 'â€”';

  /* ---------------------- current details ---------------------- */
  document.getElementById('hum').textContent    = cur.humidity != null ? cur.humidity + '%' : 'â€”';
  document.getElementById('uvi').textContent    = cur.uvi ?? 'â€”';
  document.getElementById('windSp').textContent = (cur.wind_speed ?? 'â€”') + (looksK(cur.temp) ? ' m/s' : '');
  document.getElementById('windDir').textContent= (cur.wind_deg != null ? `${cur.wind_deg}Â° ${degToCompass(cur.wind_deg)}` : 'â€”');
  document.getElementById('vis').textContent    = visFmt(cur.visibility);
  if (cur.sunrise) document.getElementById('sunrise').textContent = timeHM(cur.sunrise);
  if (cur.sunset)  document.getElementById('sunset').textContent  = timeHM(cur.sunset);

  /* ---------------------- network card ---------------------- */
  document.getElementById('ip').textContent  = geo.ip_address || 'â€”';
  const asn = geo?.connection?.autonomous_system_number;
  const org = geo?.connection?.autonomous_system_organization;
  document.getElementById('isp').textContent = [org, asn ? `AS${asn}` : null].filter(Boolean).join(' Â· ') || 'â€”';
  document.getElementById('vpn').textContent = (geo?.security?.is_vpn === true) ? 'Yes' : 'No';

  /* ---------------------- hourly 24h ---------------------- */
  const hourly = (wx.hourly || []).slice(0, 24);
  const hourlyHTML = hourly.map(h => {
    const popPct  = Math.round((h.pop || 0) * 100);
    const topIcon = popPct === 0 ? 'â˜€ï¸' : (popPct < 70 ? 'ğŸ’§' : 'ğŸ’¦');

    const rain1h = (h.rain && (h.rain['1h'] ?? h.rain['1H'])) || 0;
    const snow1h = (h.snow && (h.snow['1h'] ?? h.snow['1H'])) || 0;
    const hasSnow = snow1h > rain1h;
    const amt = (rain1h || snow1h) ? (rain1h || snow1h).toFixed(1) : 'â€”';
    const amtLabel = hasSnow ? 'Snow' : 'Rain';
    const amtIcon  = hasSnow ? 'â„ï¸' : 'ğŸ’§';

    // wind: OpenWeather gives FROM; show toward for label/arrow
    const fromDeg   = h.wind_deg ?? 0;
    const towardDeg = (fromDeg + 180) % 360;
    const towardTxt = degToCompass(towardDeg);
    const sp        = h.wind_speed ?? 'â€”';
    const needleRot = `rotate(${towardDeg}deg)`;

    const popClass = popPct === 0 ? 'zero' : (popPct < 70 ? 'mid' : 'high');

    return `
    <div class="h-card" title="${(h.weather?.[0]?.description || '').replace(/"/g,'&quot;')}">
      <div class="t">${timeHM(h.dt)}</div>
      <div class="ico">${topIcon}</div>
      <div class="temp">${tFmt(h.temp)}</div>
      <div class="feels">feels ${tFmt(h.feels_like)}</div>

      <div class="windbox" aria-label="Wind blowing toward ${towardTxt}">
        <span class="windto">${sp} m/s â†’ ${towardTxt}</span>
      </div>

      <div class="metrics">
        <div class="chip pop ${popClass}" title="Probability of precipitation">
          <span class="label">Chance</span><span class="val">${popPct}%</span>
        </div>
        <div class="chip" title="${amtLabel} amount (last/next 1h)">
          <span>${amtIcon}</span><span class="label">${amtLabel}</span><span class="val">${amt} ${amt === 'â€”' ? '' : 'mm'}</span>
        </div>
        <div class="chip" title="Relative humidity">
          <span>ğŸ’¨</span><span class="label">RH</span><span class="val">${h.humidity ?? 'â€”'}%</span>
        </div>
      </div>
    </div>`;
  }).join('');
  document.getElementById('hourlyStrip').innerHTML = hourlyHTML;

  /* ---------------------- daily 7d ---------------------- */
  const daily = (wx.daily || []).slice(0, 7);
  const allTemps = daily.flatMap(d => [d?.temp?.min, d?.temp?.max]).filter(v => typeof v === 'number');
  const toC = v => looksK(v) ? (v - 273.15) : v;
  const loAll = allTemps.length ? Math.min(...allTemps.map(toC)) : 0;
  const hiAll = allTemps.length ? Math.max(...allTemps.map(toC)) : 1;
  const rng = Math.max(4, hiAll - loAll);
  const normPct = vC => Math.min(100, Math.max(0, ((vC - loAll) / rng) * 100));
  const tTxt = v => v == null ? 'â€”' : Math.round(toC(v)) + 'Â°';
  const iconFrom = d => {
    const popPct = Math.round((d.pop || 0) * 100);
    if (popPct === 0) return 'â˜€ï¸';
    if (popPct < 70)  return 'ğŸ’§';
    return 'ğŸ’¦';
  };

  document.getElementById('dailyCompact').innerHTML = daily.map(d => {
    const dayName = dayShort(d.dt);
    const minC = toC(d?.temp?.min), maxC = toC(d?.temp?.max);
    const loPct = normPct(minC ?? loAll);
    const hiPct = normPct(maxC ?? hiAll);
    const popPct = Math.round((d.pop || 0) * 100);
    const badgeCls = popPct === 0 ? 'zero' : (popPct >= 70 ? 'high' : '');

    return `
    <div class="day-mini" title="${(d.summary || d.weather?.[0]?.description || '').replace(/"/g,'&quot;')}">
      <div class="w">${dayName}</div>
      <div class="ico">${iconFrom(d)}</div>
      <div class="bar" style="--lo:${loPct}; --hi:${hiPct};"></div>
      <div class="temps"><span>${tTxt(d.temp?.min)}</span><span>${tTxt(d.temp?.max)}</span></div>
      <div class="badge ${badgeCls}">${popPct}%</div>
    </div>`;
  }).join('');
})();
</script>
{% endblock %}