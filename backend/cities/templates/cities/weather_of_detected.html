{% extends "base.html" %}
{% load static %}

{% block title %}Current Weather{% endblock %}

{% block content %}
<section class="hero">
  <div class="place">{{ data.name }}{% if data.sys.country %}, {{ data.sys.country }}{% endif %}</div>
  <div class="big-temp" id="tempMain">{{ data.main.temp }}K</div>
  <div class="cond-line">
    {{ data.weather.0.description|title }}
    · Feels <span id="tempFeels">{{ data.main.feels_like }}K</span>
  </div>
  <div class="hilow">
    H <span id="tempMax">{{ data.main.temp_max }}K</span>
    · L <span id="tempMin">{{ data.main.temp_min }}K</span>
  </div>
</section>

<section class="grid modules">
  <!-- Left: essentials -->
  <div class="module glass">
    <div class="module-title">Essentials</div>
    <div class="kv"><span>Condition</span><b>{{ data.weather.0.main }}</b></div>
    <div class="kv"><span>Humidity</span><b>{{ data.main.humidity }}%</b></div>
    <div class="kv"><span>Pressure</span><b>{{ data.main.pressure }} hPa</b></div>
    <div class="kv"><span>Visibility</span><b id="visibilityVal">{{ data.visibility }}</b></div>
    <div class="kv"><span>Clouds</span><b>{{ data.clouds.all }}%</b></div>
    <div class="kv"><span>Sunrise</span><b id="sunriseVal">{{ data.sys.sunrise }}</b></div>
    <div class="kv"><span>Sunset</span><b id="sunsetVal">{{ data.sys.sunset }}</b></div>
    <div class="kv"><span>Observation</span><b id="obsTime">{{ data.dt }}</b></div>
    <div class="kv"><span>Timezone</span><b id="tzOffset">{{ data.timezone }}</b></div>
  </div>

  <!-- Right: wind -->
  <div class="module glass">
    <div class="module-title">Wind</div>
    <div class="kv"><span>Speed</span><b id="windSpeed">{{ data.wind.speed }}</b></div>
    <div class="kv"><span>Direction</span><b><span id="windDeg">{{ data.wind.deg }}</span>° (<span id="windCompass">—</span>)</b></div>
  </div>

  <!-- System/meta -->
  <div class="module glass">
    <div class="module-title">Location & System</div>
    <div class="kv"><span>Coordinates</span><b>{{ data.coord.lat }}, {{ data.coord.lon }}</b></div>
    <div class="kv"><span>City ID</span><b>{{ data.id }}</b></div>
    <div class="kv"><span>Base</span><b>{{ data.base }}</b></div>
    <div class="kv"><span>Code</span><b>{{ data.cod }}</b></div>
    {% if data.sys.type %}<div class="kv"><span>Sys Type</span><b>{{ data.sys.type }}</b></div>{% endif %}
    {% if data.sys.id %}<div class="kv"><span>Sys ID</span><b>{{ data.sys.id }}</b></div>{% endif %}
  </div>
</section>

<!-- Raw JSON (for debugging) -->
<section class="module glass" style="margin-top:16px;">
  <div class="module-title">Raw JSON</div>
  <pre style="white-space:pre-wrap;overflow:auto;font-size:12px;" id="rawJson"></pre>
</section>

{% endblock %}

{% block extra_js %}
{{ data|json_script:"ow-current" }}
<script>
(function () {
  const payload = JSON.parse(document.getElementById('ow-current').textContent);

  // ---- Units helpers ----
  const units = (function detectUnits() {
    // If temps look like Kelvin (>200), assume Kelvin, else metric/imperial set on server
    const t = payload?.main?.temp;
    if (typeof t !== 'number') return 'unknown';
    if (t > 200) return 'kelvin';
    // If you called API with &units=metric/imperial, you can set this explicitly via server.
    return 'api';
  })();

  function KtoC(k){ return k - 273.15; }
  function KtoF(k){ return (k - 273.15) * 9/5 + 32; }
  function fmtTemp(k){
    if (units === 'kelvin') return `${Math.round(KtoC(k))}°C`;
    // assume API provided already in desired unit → show as rounded number with ° (no unit guess)
    return `${Math.round(k)}°`;
  }
  function fmtSpeed(v){
    // If you requested metric → m/s; imperial → mph. We can't detect reliably from this payload alone.
    return `${v} ${units==='api' ? '' : (units==='kelvin' ? 'm/s' : '')}`.trim();
  }
  function fmtVis(m){
    // API gives meters; show km when large
    if (typeof m !== 'number') return '—';
    return m >= 1000 ? `${(m/1000).toFixed(1)} km` : `${m} m`;
  }
  function toLocal(ts, tzOffsetSec){
    // Convert UNIX + tz offset (seconds) to local clock string
    if (!ts) return '—';
    const d = new Date((ts + (tzOffsetSec || 0)) * 1000); // treat offset as fixed shift
    return d.toUTCString().replace(' GMT','');
  }
  function degToCompass(deg){
    if (typeof deg !== 'number') return '—';
    const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
    return dirs[Math.round(deg / 22.5) % 16];
  }

  // ---- Fill UI ----
  const tzOffset = payload.timezone || 0;

  // temps
  const tMain = document.getElementById('tempMain');
  const tFeels = document.getElementById('tempFeels');
  const tMax = document.getElementById('tempMax');
  const tMin = document.getElementById('tempMin');
  if (tMain && payload.main?.temp != null) tMain.textContent = fmtTemp(payload.main.temp);
  if (tFeels && payload.main?.feels_like != null) tFeels.textContent = fmtTemp(payload.main.feels_like);
  if (tMax && payload.main?.temp_max != null) tMax.textContent = fmtTemp(payload.main.temp_max);
  if (tMin && payload.main?.temp_min != null) tMin.textContent = fmtTemp(payload.main.temp_min);

  // wind
  const windS = document.getElementById('windSpeed');
  const windD = document.getElementById('windDeg');
  const windC = document.getElementById('windCompass');
  if (windS && payload.wind?.speed != null) windS.textContent = fmtSpeed(payload.wind.speed);
  if (windD && payload.wind?.deg != null) windD.textContent = payload.wind.deg;
  if (windC && payload.wind?.deg != null) windC.textContent = degToCompass(payload.wind.deg);

  // visibility
  const vis = document.getElementById('visibilityVal');
  if (vis && payload.visibility != null) vis.textContent = fmtVis(payload.visibility);

  // times
  const sunrise = document.getElementById('sunriseVal');
  const sunset  = document.getElementById('sunsetVal');
  const obs     = document.getElementById('obsTime');
  const tzEl    = document.getElementById('tzOffset');
  if (sunrise && payload.sys?.sunrise) sunrise.textContent = toLocal(payload.sys.sunrise, tzOffset);
  if (sunset  && payload.sys?.sunset)  sunset.textContent  = toLocal(payload.sys.sunset,  tzOffset);
  if (obs && payload.dt) obs.textContent = toLocal(payload.dt, tzOffset);
  if (tzEl) tzEl.textContent = (tzOffset >= 0 ? '+' : '') + (tzOffset/3600).toFixed(1) + 'h';

  // raw JSON
  const raw = document.getElementById('rawJson');
  if (raw) raw.textContent = JSON.stringify(payload, null, 2);

  // optional: set background based on icon code
  const icon = payload?.weather?.[0]?.icon;
  if (icon && typeof setBackgroundByIcon === 'function') setBackgroundByIcon(icon);
})();
</script>
{% endblock %}